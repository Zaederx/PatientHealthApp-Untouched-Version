<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <!-- CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <!-- Popper JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

  <!-- JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <title>Register User</title>
</head>

<body>
  <div class="jumbotron text-center">
    <h1>Admin - Register User</h1>
    <h3></h3>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark justify-content-center row">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#"><button class="btn btn-secondary active">Admin Home</button></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/logout}"><button class="btn btn-primary">Logout</button></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/admin/assistance}"><button class="btn btn-primary">Get Assistance</button></a>
        </li>
      </ul>

    </nav>
  </div>
	<div class="alert alert-info" th:if=${param.success} th:text="${param.success}">
	</div>
	<div>
	
	<!-- Accordian (card container) -->	
  <div id="accordion">
    <!-- CARD 1 - Patient Registration -->
  <div class="card text-center">
    <div class="card-header" id="headingOne">
        <button class="username-error btn btn-link" onclick="setRegBtn('#reg-btn-patient')" data-toggle="collapse" data-target="#patientCollapse" aria-expanded="true" aria-controls="patientCollapse">
          Patient
        </button>
    </div>
    <div id="patientCollapse" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
      <div class="card-body">
      <div class="container d-flex flex-sm-column col-sm-8 justify-content-center">
    	<form class="form-group" action="#" th:action="@{/admin/register-patient}" th:object="${patientRegForm}" method="POST">
		   	<label>Name</label>
		   	<input onfocus="setId('#patient-name')" id="patient-name" class="form-control text-center" type="text" th:field="*{name}" placeholder="Henry Thompson" autocomplete="off"></input>
		   <!--TODO - dismiss th:if alerts  -->
		   	<p class="alert alert-info" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></p>
		   	<div id="patient-name-error"></div>
		   	
		   	<label>Username</label>
		   	<input onfocus="setId('#patient-username'); setAddress('/is-user/');" id="patient-username" class="form-control text-center" type="text" th:field="*{username}" placeholder="Enstein92" autocomplete="off"></input>
		   	<div id="patient-username-error"></div>
		   	
		   	<label>Email</label>
		   	<input onfocus="setId('#patient-email'); setAddress('/is-valid/email/');" id="patient-email" class="form-control text-center" type="text"  th:field="*{email}" placeholder="email@email.com" autocomplete="off"></input>
		  	<div id="patient-email-error"></div>
		   	<br>
		   
		   	<label>Password</label>
		   	<input onfocus="setId('#patient-password'); setAddress('/is-valid/password/');" id= "patient-password" class="form-control text-center" type="password" th:field="*{password}" placeholder="SomeThingICanRemeber!56" 
		   	pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Please enter a password that is at least 8 characters long, has at least one uppercase and one lower letter, and contains at least one number" autocomplete="off"></input>
		   	<div id="patient-password-error"></div>
		   	
		   	<label>Repeat Password</label>
		   	<input onclick="setId('#patient-password'); setIdTwo('#patient-passwordTwo'); setAddress('/matches/');" id="patient-passwordTwo" class="form-control text-center" type="password" th:field="*{password2}" placeholder="SomeThingICanRemeber!56" autocomplete="off"/>
		   	<div id="patient-passwordTwo-error"></div>
		   	<br>
		   	<button id="reg-btn-patient" class="btn btn-primary" type="submit">Register</button>
    	</form>
       </div>
      </div>
    </div>
  </div>
  
  <!-- CARD 2 - Doctor Registration  -->
  <div class="card text-center">
    <div class="card-header" id="headingTwo">
        <button onclick="setRegBtn('#reg-btn-doctor');"class="btn btn-link collapsed" data-toggle="collapse" data-target="#doctorCollapse" aria-expanded="false" aria-controls="doctorCollapse">
          Doctor
        </button>
    </div>
    <div id="doctorCollapse" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
      <div class="card-body">
      	<div class="container d-flex flex-sm-column col-sm-8 justify-content-center">
	        <form class="form-group" action="#" th:action="@{/admin/register-doctor}" th:object="${doctorRegForm}" method="POST">
			   	<label>Name</label>
			   	<input onfocus="setId('#doctor-name');" id="doctor-name"class="form-control text-center" type="text" th:field="*{name}" placeholder="Henry Thompson" pattern="{1,}" title="This field cannot be empty" autocomplete="off"></input>
			   	<div id="doctor-name-error"></div>
			   	
			   	<label>GMC Reference Number</label><!--General Medical Council Number - Each doctor in UK is meant to have one  -->
	    		<input onfocus="setId('#doctor-gmc'); setAddress('/is-valid/gmc/');" id="doctor-gmc" class="form-control text-center" type="text" th:field="*{gmcNum}" placeholder="3494984098345" autocomplete="off"></input>
			   	<div id="doctor-gmc-error"></div>
			   	
			   	<label>Username</label>
			   	<input onfocus="setId('#doctor-username'); setAddress('/is-user/');"id="doctor-username" class="form-control text-center" type="text" th:field="*{username}" placeholder="Enstein92" autocomplete="off"></input>
			   	<div id="doctor-username-error"></div>
			   
			   	<label>Password</label>
			   	<input onfocus="setId('#doctor-password'); setAddress('/is-valid/password/');"id="doctor-password" class="form-control text-center" type="password" th:field="*{password}" placeholder="SomeThingICanRemeber!56" 
			   	pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Please enter a password that is at least 8 characters long, has at least one uppercase and one lower letter, and contains at least one number" autocomplete="off"></input>
			   	<div id="doctor-password-error"></div>
			   	<br>
			   	<button id="reg-btn-doctor" class="btn btn-secondary" type="submit">Register</button>
	    	</form>
    	</div>
      </div>
    </div>
  </div>

  <!-- CARD 3 - Admin Registration -->
  <div class="card text-center">
    <div class="card-header text-center" id="headingThree">
        <button onclick="setRegBtn('#reg-btn-admin');" class="btn btn-link collapsed" data-toggle="collapse" data-target="#admin" aria-expanded="false" aria-controls="admin">
          Admin
        </button>
    </div>
    <div id="admin" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
      <div class="card-body">
        <div class="container d-flex flex-sm-column col-sm-8 justify-content-center">
	        <form class="form-group" action="#" th:action="@{/admin/register-admin}" th:object="${adminRegForm}" method="POST">
			   	<label>Name</label>
			   	<input onfocus="setId('#admin-name');" id="admin-name" class="form-control text-center" type="text" th:field="*{name}" placeholder="Henry Thompson" pattern="{1,}" title="This field cannot be empty" autocomplete="off"></input>
			   	<div id="admin-name-error"></div>
			   	
			   	<label>Username</label>
			   	<input onfocus="setId('#admin-username'); setAddress('/is-user/');" id="admin-username" class="form-control text-center" type="text" th:field="*{username}" placeholder="Enstein92" autocomplete="off"></input>
			   	<div id="admin-username-error"></div>
			   	<label>Password</label>
			   	<input onfocus="setId('#admin-password'); setAddress('/is-valid/password/');"class="form-control text-center" type="password" th:field="*{password}" placeholder="SomeThingICanRemeber!56" 
			   	pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Please enter a password that is at least 8 characters long, has at least one uppercase and one lower letter, and contains at least one number" autocomplete="off"></input>
			   	<div id="admin-password-error"></div>
				<br>
			   	
			   	
			   	
			   	<button id="reg-btn-admin" class="btn btn-primary" type="submit">Register</button>
	    	</form>
    	</div>
      </div>
    </div>
  </div>
  
  
</div><!-- accordian div end -->
</div> <!-- container div end  -->

</body>
<script>

/* Get Error Request Parameter */
var params = new URLSearchParams(window.location.search);
var error = params.has('error');
/* Default alert and inputfield Id's */
var alertId = '#patient-username-error';
var inputFieldId = '#patient-username';
/* Second inputField - used for password checking */
var inputFieldIdTwo = null;
var regButton = '#reg-btn-one';
var address = "/ajax/is-user/";//+$(inputFieldId).val()??
var url = "";
function setId(regId, uId, button) {
	alertId = regId;
	inputFieldId = uId;
	regButton = button;
	console.log(alertId);
	console.log(inputFieldId);
}

function setId(id) {
	inputFieldId = id;
	alertId = id+'-error';
	console.log('inputFieldId'+inputFieldId);
}

function setIdTwo(idTwo) {
	inputFieldIdTwo = idTwo;
}

function setRegBtn(button) {
	regButton = button;
}

function setAddress(a) {
	address = '/ajax'+a;
}

function setURL() {
	if (inputFieldId.includes("password") && $(inputFieldId).val() != '' && $(inputFieldIdTwo).val() != null) {//contains method for generalisation of function
		console.log('password ajax url');
	url = address+$(inputFieldId).val()+'/'+$(inputFieldIdTwo).val();//for password and passwordTwo
	} else if ($(inputFieldIdTwo).val() != null) {
	url = address+$(inputFieldIdTwo).val();//for passwordTwo
	} else {
	url = address+$(inputFieldId).val();//for regular inputfield
	}
	console.log('url:'+url);
}


/*Make button unusable*/
function disableButton () {
	/*remove old css*/
	$(regButton).removeClass("btn-primary");
	
	/*add new css + attribute*/
	$(regButton).attr("disabled",true);
	$(regButton).addClass("disabled");
	$(regButton).addClass("btn-secondary");
}

/*Make button usuable*/
function enableButton () {
	/*remove old css + attribute*/
	$(regButton).attr("disabled",false);
	$(regButton).removeClass("disabled");
	$(regButton).removeClass("btn-secondary");
	/*add new css*/
	$(regButton).addClass("btn-primary");
}

function notEmpty(s) {
	if (s != null && s != undefined && s != "") {
		return s;
	}
}


function validateUsername() {
	$(':input').keyup(function(){
		$(alertId).hide();//reset alert
		enableButton();//reset button
		setURL();
		/*Check whether data is valid entry*/
		$.ajax({
			type:"GET",
			url:url,
			success: function(result) {
				console.log(result);
				 if ($.trim(result) == '{}') {
					console.log(result);
				} else {
					var str = JSON.stringify(result);
					var data = JSON.parse(str);//doesn't work without stringify in firefox
					var res = data.response;
					console.log("Ready functions working.");
					if (res == true) {
						disableButton();
						var errorMessage = data.errorMessage;
						$(alertId).show();
						$(alertId).html('<p class="alert alert-info">'+errorMessage+'</p>');			
						console.log(errorMessage);
					} else {
						enableButton();
						$(alertId).hide();
						console.log("Available username.");
					}
				 } 
			}
		});
	});
}


$(document).ready(function(){
	validateUsername();
	if (error == true) {disableButton();}
	
});
</script>
</html>
